name: Auto Tag and Release

on:
  push:
    branches:
      - main

jobs:
  release:
    # Skip if the commit was a version sync from this workflow
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch
          initial_version: 0.1.0
          tag_prefix: v

      - name: Sync version to package.json
        run: |
          VERSION="${{ steps.tag_version.outputs.new_version }}"
          node -e "
            const pkg = require('./package.json');
            pkg.version = '${VERSION}';
            require('fs').writeFileSync(
              './package.json',
              JSON.stringify(pkg, null, 2) + '\n'
            );
          "

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git diff --cached --quiet || \
            git commit -m "chore(release): bump version to ${{ steps.tag_version.outputs.new_version }} [skip ci]"
          git push

      - name: Create a GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag_version.outputs.new_tag }}
          name: Release ${{ steps.tag_version.outputs.new_tag }}
          body: ${{ steps.tag_version.outputs.changelog }}
